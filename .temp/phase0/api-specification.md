# GCPHound Frontend API Specification

## Overview

This document defines the API contract between the GCPHound Python backend and the new React frontend. The API supports both file-based data exchange and potential future HTTP endpoints.

## Data Exchange Methods

### Method 1: File-Based (Current Implementation)
The React frontend reads JSON files generated by the Python backend:
- **Graph Data**: `graph/gcphound_graph_*.json`
- **Analysis Results**: `findings/gcphound_analysis_*.json`
- **Collection Metadata**: `data/gcphound_complete_*.json`

### Method 2: HTTP API (Future Enhancement)
RESTful endpoints for real-time data access:
- **Base URL**: `http://localhost:8000/api/v1`
- **Authentication**: Optional Bearer token or API key
- **Content-Type**: `application/json`

## Core Data Structures

### 1. Graph Data Structure

**File**: `graph/gcphound_graph_*.json`

```typescript
interface GraphData {
  nodes: Node[];
  edges: Edge[];
  metadata: GraphMetadata;
}

interface Node {
  id: string;                    // Unique identifier (e.g., "user:alice@example.com")
  type: NodeType;               // Node classification
  name: string;                 // Display name
  properties: NodeProperties;   // Type-specific data
}

interface Edge {
  source: string;               // Source node ID
  target: string;               // Target node ID
  type: EdgeType;              // Relationship type
  properties: EdgeProperties;  // Edge-specific data
}

interface GraphMetadata {
  total_nodes: number;
  total_edges: number;
  collection_time: string;      // ISO 8601 timestamp
  gcp_projects: string[];
  gcp_organization?: string;
  generator_version: string;
}
```

### 2. Analysis Results Structure

**File**: `findings/gcphound_analysis_*.json`

```typescript
interface AnalysisResults {
  statistics: Statistics;
  attack_paths: AttackPathsByCategory;
  risk_scores: RiskScores;
  vulnerabilities: Vulnerability[];
  critical_nodes: CriticalNode[];
  dangerous_roles: DangerousRole[];
}

interface Statistics {
  total_nodes: number;
  total_edges: number;
  attack_paths: number;
  high_risk_nodes: number;
  dangerous_roles: number;
  privilege_escalation_paths: number;
  lateral_movement_paths: number;
  critical_nodes: number;
  vulnerabilities: number;
}

interface AttackPathsByCategory {
  critical: AttackPath[];
  critical_multi_step: AttackPath[];
  privilege_escalation: AttackPath[];
  lateral_movement: AttackPath[];
  high: AttackPath[];
  medium: AttackPath[];
  low: AttackPath[];
}

interface AttackPath {
  source: PathNode;
  target: PathNode;
  path_nodes: PathNode[];
  path_edges: PathEdge[];
  risk_score: number;           // 0.0 to 1.0
  description: string;
  length: number;               // Number of edges
  category: string;
  visualization_metadata?: VisualizationMetadata;
}
```

### 3. Risk Scoring Structure

```typescript
interface RiskScores {
  [nodeId: string]: NodeRiskScore;
}

interface NodeRiskScore {
  base: number;                 // Base risk (0.0 to 1.0)
  centrality: number;          // Graph centrality score
  total: number;               // Combined risk score
  factors: RiskFactor[];       // Contributing risk factors
}

interface RiskFactor {
  type: string;                // e.g., "dangerous_role", "high_privilege"
  impact: number;              // Risk contribution (0.0 to 1.0)
  description: string;
}
```

## Enumerated Types

### Node Types
```typescript
enum NodeType {
  USER = "user",
  SERVICE_ACCOUNT = "service_account",
  GROUP = "group",
  PROJECT = "project",
  FOLDER = "folder",
  ORGANIZATION = "organization",
  ROLE = "role",
  CUSTOM_ROLE = "custom_role",
  BUCKET = "bucket",
  INSTANCE = "instance",
  FUNCTION = "function",
  SECRET = "secret",
  KMS_KEY = "kms_key",
  DATASET = "dataset",
  TOPIC = "topic",
  CLOUD_RUN_SERVICE = "cloud_run_service",
  GKE_CLUSTER = "gke_cluster",
  CLOUD_BUILD_TRIGGER = "cloud_build_trigger"
}
```

### Edge Types
```typescript
enum EdgeType {
  // Standard relationships
  HAS_ROLE = "has_role",
  MEMBER_OF = "member_of",
  PARENT_OF = "parent_of",
  CAN_READ = "can_read",
  CAN_WRITE = "can_write",
  CAN_ADMIN = "can_admin",
  
  // Privilege escalation relationships
  CAN_IMPERSONATE_SA = "can_impersonate_sa",
  CAN_CREATE_SERVICE_ACCOUNT_KEY = "can_create_service_account_key",
  CAN_ACT_AS_VIA_VM = "can_act_as_via_vm",
  CAN_DEPLOY_FUNCTION_AS = "can_deploy_function_as",
  CAN_DEPLOY_CLOUD_RUN_AS = "can_deploy_cloud_run_as",
  CAN_TRIGGER_BUILD_AS = "can_trigger_build_as",
  CAN_LOGIN_TO_VM = "can_login_to_vm",
  CAN_DEPLOY_GKE_POD_AS = "can_deploy_gke_pod_as",
  
  // Audit log confirmed relationships
  HAS_IMPERSONATED = "has_impersonated",
  HAS_ESCALATED_PRIVILEGE = "has_escalated_privilege",
  HAS_ACCESSED = "has_accessed"
}
```

## Extended Data Structures

### Node Properties by Type

#### User Node
```typescript
interface UserProperties {
  email: string;
  domain: string;
  is_external: boolean;
  last_seen?: string;           // ISO 8601 timestamp
  groups: string[];            // Group memberships
}
```

#### Service Account Node
```typescript
interface ServiceAccountProperties {
  email: string;
  project_id: string;
  display_name?: string;
  description?: string;
  is_default: boolean;         // Default compute/app engine SA
  key_count: number;           // Number of keys
  disabled: boolean;
  last_used?: string;          // ISO 8601 timestamp
}
```

#### Role Node
```typescript
interface RoleProperties {
  title: string;
  description: string;
  is_custom: boolean;
  permissions: string[];       // Array of GCP permissions
  is_dangerous: boolean;       // Predefined dangerous role
  stage?: string;              // GA, BETA, ALPHA
}
```

#### Project Node
```typescript
interface ProjectProperties {
  project_id: string;
  display_name: string;
  parent?: string;             // Parent folder/organization
  state: string;               // ACTIVE, DELETE_REQUESTED
  labels: Record<string, string>;
  create_time: string;         // ISO 8601 timestamp
}
```

### Edge Properties

#### HAS_ROLE Edge
```typescript
interface HasRoleProperties {
  resource: string;            // projects/my-project
  role: string;               // roles/editor
  condition?: IAMCondition;    // IAM condition if present
  inherited: boolean;         // Inherited from parent resource
}

interface IAMCondition {
  title: string;
  description: string;
  expression: string;          // CEL expression
}
```

#### Privilege Escalation Edge
```typescript
interface PrivilegeEscalationProperties {
  technique: string;           // Attack technique name
  via_role: string;           // Role that enables this escalation
  permission: string;         // Required GCP permission
  resource_scope: string;     // Scope of access (project/org/folder)
  confidence: number;         // 0.0 to 1.0 confidence score
  evidence?: string[];        // Supporting evidence
}
```

## HTTP API Endpoints (Future)

### Graph Endpoints

#### Get Graph Data
```http
GET /api/v1/graph/latest
GET /api/v1/graph/{timestamp}

Response: GraphData
```

#### Get Graph Statistics
```http
GET /api/v1/graph/statistics

Response: {
  total_nodes: number;
  total_edges: number;
  node_types: Record<NodeType, number>;
  edge_types: Record<EdgeType, number>;
  last_updated: string;
}
```

### Analysis Endpoints

#### Get Analysis Results
```http
GET /api/v1/analysis/latest
GET /api/v1/analysis/{timestamp}

Response: AnalysisResults
```

#### Get Attack Paths
```http
GET /api/v1/analysis/attack-paths?category={category}&min_risk={risk}

Query Parameters:
- category: string (optional) - Filter by path category
- min_risk: number (optional) - Minimum risk score (0.0-1.0)
- limit: number (optional) - Maximum paths to return
- offset: number (optional) - Pagination offset

Response: {
  paths: AttackPath[];
  total: number;
  has_more: boolean;
}
```

#### Get Risk Scores
```http
GET /api/v1/analysis/risk-scores?node_type={type}&min_risk={risk}

Response: RiskScores
```

### Search Endpoints

#### Search Nodes
```http
GET /api/v1/search/nodes?q={query}&type={type}&limit={limit}

Query Parameters:
- q: string - Search query (name, email, ID)
- type: NodeType (optional) - Filter by node type
- limit: number (optional) - Maximum results (default 50)

Response: {
  nodes: Node[];
  total: number;
}
```

#### Search Paths
```http
GET /api/v1/search/paths?source={nodeId}&target={nodeId}&max_length={length}

Response: {
  paths: AttackPath[];
  total: number;
}
```

## Data Validation

### JSON Schema Validation
All JSON responses must validate against predefined JSON schemas:

- `graph-data.schema.json` - Graph data structure
- `analysis-results.schema.json` - Analysis results structure  
- `attack-path.schema.json` - Attack path structure
- `node.schema.json` - Node structure
- `edge.schema.json` - Edge structure

### Required Fields
All objects must include:
- **Nodes**: `id`, `type`, `name`
- **Edges**: `source`, `target`, `type`
- **Attack Paths**: `source`, `target`, `risk_score`, `length`
- **Statistics**: All numeric fields (default to 0)

### Data Constraints
- **Risk Scores**: Must be between 0.0 and 1.0
- **Timestamps**: Must be valid ISO 8601 format
- **Node IDs**: Must follow format `{type}:{identifier}`
- **Edge Types**: Must be valid EdgeType enum values

## Error Handling

### Error Response Format
```typescript
interface APIError {
  error: {
    code: string;              // Machine-readable error code
    message: string;           // Human-readable error message
    details?: any;             // Additional error context
    timestamp: string;         // ISO 8601 timestamp
  };
}
```

### Common Error Codes
- `GRAPH_NOT_FOUND` - Requested graph data not available
- `ANALYSIS_NOT_READY` - Analysis still in progress
- `INVALID_PARAMETERS` - Invalid query parameters
- `VALIDATION_ERROR` - Data validation failed
- `INTERNAL_ERROR` - Unexpected server error

## Versioning

### API Version Strategy
- **Current Version**: v1
- **Version Header**: `Accept: application/vnd.gcphound.v1+json`
- **Backward Compatibility**: Maintained for at least 2 major versions
- **Deprecation Notice**: 6 months advance notice for breaking changes

### Data Format Evolution
- **Additive Changes**: New fields added without version bump
- **Breaking Changes**: Require new API version
- **Field Deprecation**: Marked with `@deprecated` in documentation

## Performance Considerations

### Data Size Limits
- **Maximum Nodes**: 10,000 per request
- **Maximum Edges**: 50,000 per request
- **Maximum Attack Paths**: 1,000 per request
- **Response Size**: 10MB maximum

### Caching Strategy
- **Graph Data**: Cache for 1 hour (analysis rarely changes)
- **Statistics**: Cache for 5 minutes
- **Search Results**: Cache for 15 minutes
- **ETags**: Support for conditional requests

### Pagination
Large datasets use cursor-based pagination:
```typescript
interface PaginatedResponse<T> {
  data: T[];
  pagination: {
    total: number;
    limit: number;
    offset: number;
    has_more: boolean;
    next_cursor?: string;
  };
}
```

This API specification provides a complete contract for frontend-backend communication, supporting both current file-based integration and future real-time capabilities. 