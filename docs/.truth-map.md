## EscaGCP Truth Map

Authoritative reference extracted from code and config. Source files: `escagcp/cli.py`, `escagcp/config/default.yaml`, `escagcp/graph/{models.py,builder.py,exporter.py,query.py}`, `escagcp/analyzers/paths.py`.

### CLI commands and flags

| Command | Flags | Defaults | Notes/Examples |
| --- | --- | --- | --- |
| `escagcp --config PATH COMMAND` | `--config, -c` | Loads YAML; default `config/default.yaml` relative to CWD if present, otherwise in‑code defaults | Top‑level group in `cli.py` |
| `collect` | `--organization, -o` • `--folders, -f` (repeat) • `--projects, -p` (repeat) • `--output, -O` • `--include-logs` • `--log-days` | output `data/`; log-days `7` | Example: `escagcp collect -p PROJECT_ID -O data/` |
| `build-graph` | `--input, -i` • `--output, -o` | input `data/`; output `graph/` | Uses latest `escagcp_complete_*.json` from input |
| `analyze` | `--graph, -g` (file or glob or dir) • `--output, -o` • `--format {json,html,text}` • `--visualize-attack-paths` | output `findings/`; format `json` | Auto-picks latest `graph/escagcp_graph_*.json` if `-g` omitted |
| `visualize` | `--graph, -g` • `--output, -o` • `--type/--viz-type {full,attack-paths,risk}` • `--format {html,graphml}` | type `full`; format `html`; output `visualizations/` | HTML writes `visualizations/escagcp_graph_{ts}.html` (full) or `escagcp_attack_paths_{ts}.html` (attack-paths) or `escagcp_risk_graph_{ts}.html` (risk) |
| `simulate` | `--graph, -g` • `--action {add,remove,change}` (required) • `--member, -m` (required) • `--role, -r` (required) • `--resource, -R` (required) • `--new-role` (for `change`) | — | Simulates IAM changes, prints impact |
| `query` | `--graph, -g` • `--from` (required) • `--to` • `--type {paths,permissions,access}` | type `paths` | Identity/resource parsing per `graph/query.py` |
| `run` | `--lazy` • `--projects, -p` (repeat) • `--open-browser` • `--use-old-dashboard` | `--open-browser` true | Lazy flow: collect → build‑graph → analyze → visualize or React dashboard |
| `export` | `--graph, -g` • `--output, -o` | output `escagcp_report.html` | Standalone HTML report (no `--title` flag) |
| `simple-export` | `--graph, -g` (supports `*`) • `--output, -o` | output `escagcp_simple_report.html` | Minimal dependency‑free HTML |
| `cleanup` | `--force, -f` • `--dry-run` | — | Removes generated files; see `cli.py` for patterns |
| `list-attack-types` | (none) | — | Prints supported escalation edge types and descriptions |

Examples:

```bash
escagcp collect -p PROJECT_ID
escagcp build-graph -i data/ -o graph/
escagcp analyze -g graph/escagcp_graph_*.json -o findings/ --format json
escagcp visualize -g graph/escagcp_graph_*.json -o visualizations/ --type attack-paths
escagcp export -g graph/escagcp_graph_*.json -o escagcp_report.html
```

### Output file patterns

- Collection: `data/escagcp_complete_{YYYYMMDD_HHMMSS}.json` (plus per‑collector files)
- Graph: `graph/escagcp_graph_{YYYYMMDD_HHMMSS}.json` and `.graphml`
- Analysis: `findings/escagcp_analysis_{YYYYMMDD_HHMMSS}.json|html|txt`
- Visualizations (HTML):
  - Full: `visualizations/escagcp_graph_{YYYYMMDD_HHMMSS}.html`
  - Attack paths: `visualizations/escagcp_attack_paths_{YYYYMMDD_HHMMSS}.html`
  - Risk: `visualizations/escagcp_risk_graph_{YYYYMMDD_HHMMSS}.html`

### Node types (`graph/models.py`)

`user`, `service_account`, `group`, `project`, `folder`, `organization`, `role`, `resource`, `bucket`, `instance`, `function`, `dataset`, `secret`, `kms_key`, `topic`, `cloud_run_service`, `gke_cluster`, `gke_workload`, `tag`, `tag_value`, `custom_role`, `workload_identity_provider`, `cloud_build_trigger`, `compute_instance`.

### Edge types (`graph/models.py`)

Core: `has_role`, `member_of`, `can_impersonate`, `owns`, `inherits`, `has_permission`, `parent_of`, `uses_service_account`, `has_access_to`, `can_invoke`, `can_read`, `can_write`, `can_admin`.

Escalation/advanced: `can_impersonate_sa`, `can_create_service_account_key`, `can_act_as_via_vm`, `can_deploy_function_as`, `can_deploy_cloud_run_as`, `can_trigger_build_as`, `can_login_to_vm`, `runs_as`, `can_satisfy_iam_condition`, `external_principal_can_impersonate`, `can_hijack_workload_identity`, `can_modify_custom_role`, `can_launch_as_default_sa`, `can_attach_service_account`, `can_update_metadata`, `can_deploy_gke_pod_as`, `can_assign_custom_role`, `has_tag_binding`, `can_create_tag_binding`, `has_conditional_role`, `can_ssh_and_impersonate`, `has_tag_binding_escalation`, `has_impersonated`, `has_escalated_privilege`, `has_accessed`.

### Attack technique categories (from analyzer + CLI list)

- Critical: `can_impersonate_sa`, `can_create_service_account_key`, `external_principal_can_impersonate`, `has_escalated_privilege` (audit‑confirmed)
- High: `can_deploy_function_as`, `can_deploy_cloud_run_as`, `can_act_as_via_vm`, `can_trigger_build_as`, `can_deploy_gke_pod_as`, `can_modify_custom_role`, `can_assign_custom_role`, `can_ssh_and_impersonate`, `has_tag_binding_escalation`
- Medium: `can_login_to_vm`, `can_launch_as_default_sa`, `can_update_metadata`

See `escagcp/analyzers/paths.py` and `list-attack-types` for descriptions and required permissions.

### Risk thresholds (defaults)

From `escagcp/config/default.yaml`:

- Critical: 0.8
- High: 0.6
- Medium: 0.4
- Low: 0.2

### Known unsupported/absent flags (do not document as available)

- No `--title` flag on `export`
- No `--min-risk` or `--exclude-low-risk` flags on `visualize` or `export`
- No `validate-config` command


